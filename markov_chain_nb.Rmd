---
title: "Look into markov chains"
output:
  pdf_document: default
  html_notebook: default
---


```{r}
rand <- sample(1:3, 100, replace=TRUE)
hist(rand)

norm <- as.integer(rnorm(100,mean=2, sd=1))

unif <- as.integer(runif(100, min=1, max=4))
```

```{r}
library(markovchain)

mcWeather <- new("markovchain", states=c("sunny","cloudy","rain"), transitionMatrix = matrix(data=c(0.70,0.2,0.1, 0.3,0.4,0.3,0.2,0.45,0.35),byrow=T, nrow=3),name="Weather")

weatherOfDays <- rmarkovchain(n=365, object=mcWeather, t0="sunny")


tmp <- markovchainFit(data=weatherOfDays, method="mle", name = "Weather MLE")

plot(mcWeather)
plot(tmp$estimate)

mcWeather
tmp$estimate

test <- markovchainFit(data=rand, method="mle", name="Bird jumping")
plot(test$estimate)

test2 <- markovchainFit(data=norm, method="mle", name="normal birds")
plot(test2$estimate)

test3 <- markovchainFit(data=unif, method="mle", name="uniform birds")
plot(test3$estimate)

```

```{r, overall 6928 markov chain}
six_nine_two_eight <- read.csv("6928.csv")

six_nine_two_eight["DateTime"] <- as.POSIXct(six_nine_two_eight$access, origin="1970-01-01", tz="GMT")

six_nine_two_eight_uniq <-subset(six_nine_two_eight, subzone!="test")

unique(six_nine_two_eight_uniq$subzone)

test <- markovchainFit(data=six_nine_two_eight_uniq$subzone, method="mle", name="Tag number 6928 overal")
test
plot(test$estimate)

```

```{r, function to calc transitions}
sep_bird_id_xts <- function(samp_name, samp_id,cage_obj){
  
  raw_sample_tab <- subset(cage_obj, tagname==samp_id)
  
  xts_object <- xts(raw_sample_tab ,order.by = raw_sample_tab$DateTime)
  
  result <- list("name" = samp_name, "ID"=samp_id, "xts_obj"=xts_object)
  return(result)
}

sep_bird_id_period <- function(samp_name, samp_id, cage_obj, cutoff){
  
  raw_sample_tab <- subset(cage_obj, tagname==samp_id)
  
  xts_object <- xts(raw_sample_tab ,order.by = raw_sample_tab$DateTime)
  
  xts_object <- xts_object[cutoff]
  
  daily <- to.daily(xts_object$subzone, OHLC=F,)
  weekly <- to.weekly(xts_object$subzone, OHLC=F)
  monthly <- to.monthly(xts_object$subzone, OHLC=F)
  index(monthly) <-as.POSIXct(index(monthly))
  
  result <- list("name" = samp_name, "ID"=samp_id, "xts_obj"=xts_object, "daily_obj"=daily,
                 "weekly_obj"=weekly, "monthly_obj"=monthly)
  return(result)
}

#input a sample name
#returns a vector labeled with sample name, and bottom, middle, top and total transitions

calc_trans<- function(samp_name,samp_obj){
  bottom_trans <-0
  mid_trans<-0
  top_trans<-0
  trans<-0
  count <- 0
  
  for (i in 2:length(samp_obj$subzone)) {
  previous_state <- as.character(samp_obj$subzone[i-1])
  current_state <- as.character(samp_obj$subzone[i])
  
  #print(paste(previous_state,":",current_state))
  
  
  if (previous_state == current_state) {
    count <- count+1
    
  }
  else{
    
    if(current_state == "bottom" || current_state == "Bottom"){
      bottom_trans <- bottom_trans+1
      trans<- trans+1
    }
    if (current_state=="middle" || current_state == "Middle") {
      mid_trans <- mid_trans+1
      trans <- trans+1
    }
    if(current_state =="top" || current_state=="Top"){
      top_trans <- top_trans+1
      trans <- trans+1
    }
  }
  }
  result <- c(samp_name,bottom_trans,mid_trans,top_trans,trans)
  return(result)
  
}

calc_trans_period<- function(samp_name, daily_indexed, raw_table,freq){
  result <- data.frame()
  
  for (i in 2:(length(daily_indexed))){
    curr_day <- raw_table[paste0(index(daily_indexed)[i-1],"/",index(daily_indexed)[i])]
    curr_day_trans <- calc_trans(paste0(samp_name,".",freq,".",i),curr_day)
    result <- rbind(result,curr_day_trans)
    }
  colnames(result) <- c("sample","bottom","mid","top","total")
  return(result)
}
```


```{r, setup zoo for six eight nine four}
library(xts)

six_eight_nine_four <- read.csv("6894.csv")

bird_ids_6894 <- na.trim(unique(six_eight_nine_four$tagname))
bird_ids_6894 <- sort(bird_ids_6894)

six_eight_nine_four <- six_eight_nine_four[order(six_eight_nine_four$access),] 

six_eight_nine_four["DateTime"] <- as.POSIXct(six_eight_nine_four$access, origin="1970-01-01", tz="GMT")

unique(six_eight_nine_four$subzone)

six_eight_nine_four$subzone[six_eight_nine_four$subzone == "M"] <- "middle"
six_eight_nine_four$subzone[six_eight_nine_four$subzone == "B"] <- "bottom"
six_eight_nine_four$subzone[six_eight_nine_four$subzone == "T"] <- "top"

unique(six_eight_nine_four$subzone)

sum(is.na(six_eight_nine_four$DateTime))

six_eight_nine_four <- six_eight_nine_four[!is.na(six_eight_nine_four$DateTime),]

sum(is.na(six_eight_nine_four$DateTime))

#res <- sep_bird_id(samp_name = "6894",cage_obj = six_eight_nine_four,samp_id = bird_ids_6894[1])

#generate list of XTS objects 
reslist_6894 <- list()
for(i in 1:length(bird_ids_6894)){
  
  res <- sep_bird_id_xts(samp_name="6894",cage_obj =six_eight_nine_four, samp_id = bird_ids_6894[i])
  reslist_6894[[i]] <- res
}

#summarize the xts objects to find a period of time that 
for(item in reslist_6894){
  print(item$ID)
  print(summary(item$xts_obj))
}

remove <- c("6862","6880","6881")
bird_ids_6894_new <- bird_ids_6894 [! bird_ids_6894  %in% remove ]
#generate list of the first 10 truncated XTS objects
reslist2_6894 <- list()
for(i in 1:7){
  res <- sep_bird_id_period(samp_name="6894",cage_obj =six_eight_nine_four, samp_id = bird_ids_6894_new[i],cutoff = "2020-12-02 23:00:00/2021-02-18 10:00:00")
  reslist2_6894[[i]] <- res
}

#summarize the xts objects to check that the truncation worked
for(item in reslist2_6894){
  print(item$ID)
  print(summary(item$xts_obj))
  print(item$daily_obj)
}

#find wholly non-na daily timeset, to be able to feed into the transcalc
big_table_6894 <- reslist2_6894[[1]]$daily_obj
for(i in 2:length(reslist2_6894)){
  current <- reslist2_6894[[i]]$daily_obj
  big_table_6894 <- cbind(big_table_6894,current)
}
print(sum(is.na(big_table_6894)))
print(head(big_table_6894))

remove <- c("9059")
bird_ids_6894_new <- bird_ids_6894 [! bird_ids_6894  %in% remove ]
#generate list of the first 10 truncated XTS objects
reslist3_6894 <- list()
for(i in 11:14){
  res <- sep_bird_id_period(samp_name="6894",cage_obj =six_eight_nine_four, samp_id = bird_ids_6894_new[i],cutoff = "2021-02-18 T16:00:00/2021-05-05 T23:00:00")
  reslist3_6894[[i]] <- res
}

#find wholly non-na daily timeset, to be able to feed into the transcalc
big_table_2_6894 <- reslist3_6894[[11]]$daily_obj
for(i in 12:length(reslist3_6894)){
  current <- reslist3_6894[[i]]$daily_obj
  big_table_2_6894 <- cbind(big_table_2_6894,current)
}
print(big_table_2_6894)

#summary(res$xts_obj)

#xts_6894 <- xts(six_eight_nine_four,order.by = six_eight_nine_four$DateTime)

#summary(xts_6894)

#daily_6894 <- to.daily(xts_6894$subzone, OHLC=F,)
#weekly_6894 <- to.weekly(xts_6894$subzone, OHLC=F)
#monthly_6894 <- to.monthly(xts_6894$subzone, OHLC=F)
#index(monthly_6894) <-as.POSIXct(index(monthly_6894))

#length(daily_6894)

#six_eight_nine_four_daily <- calc_trans_period("6894",daily_6894,xts_6894,"d")

#six_eight_nine_four_weekly <- calc_trans_period("6894",weekly_6894,xts_6894,"w")

#six_eight_nine_four_monthly <- calc_trans_period("6894",monthly_6894,xts_6894,"m")

#TODO fix these write calls once the data is concated
write.csv(six_eight_nine_four_daily,"6894_daily.csv",row.names = F)
write.csv(six_eight_nine_four_weekly,"6894_weekly.csv",row.names=F)
write.csv(six_eight_nine_four_monthly,"6894_monthly.csv",row.names=F)
```


```{r, generate transiton tables for 6928}
#65530
six_nine_two_eight <- read.csv("6928.csv")

bird_ids_6928 <- na.trim(unique(six_nine_two_eight$tagname))
bird_ids_6928 <- sort(bird_ids_6928)

six_nine_two_eight["DateTime"] <- as.POSIXct(six_nine_two_eight$access, origin="1970-01-01", tz="GMT")

unique(six_nine_two_eight$subzone)

six_nine_two_eight$subzone[six_nine_two_eight$subzone == "Bottom"] <- "bottom"
six_nine_two_eight$subzone[six_nine_two_eight$subzone == "middle"] <- "middle"
six_nine_two_eight$subzone[six_nine_two_eight$subzone == "Top"] <- "top"
six_nine_two_eight <-subset(six_nine_two_eight, subzone!="test")
#65475
unique(six_nine_two_eight$subzone)

sum(is.na(six_nine_two_eight$DateTime))
sum(is.na(six_nine_two_eight$subzone))

#generate list of XTS objects 
reslist_6928 <- list()
for(i in 1:length(bird_ids_6928)){
  
  res <- sep_bird_id_xts(samp_name="6928",cage_obj =six_nine_two_eight, samp_id = bird_ids_6928[i])
  reslist_6928[[i]] <- res
}

#summarize the xts objects to find a period of time that 
for(item in reslist_6928){
  print(item$ID)
  print(summary(item$xts_obj))
}

remove <- c("6941","6974","9009","9011")
bird_ids_6928_new <- bird_ids_6928 [! bird_ids_6928  %in% remove ]
#generate list of the first 10 truncated XTS objects
reslist2_6928 <- list()
for(i in 1:length(bird_ids_6928_new)){
  res <- sep_bird_id_period(samp_name="6928",cage_obj =six_nine_two_eight, samp_id = bird_ids_6928_new[i],cutoff = "2021-02-18 T16:00:00/2021-05-05 T23:00:00")
  reslist2_6928[[i]] <- res
}

#summarize the xts objects to check that the truncation worked
for(item in reslist2_6928){
  print(item$ID)
  print(summary(item$xts_obj))
  print(item$daily_obj)
}

#find wholly non-na daily timeset, to be able to feed into the transcalc
big_table_6928 <- reslist2_6928[[1]]$daily_obj
for(i in 2:length(reslist2_6928)){
  current <- reslist2_6928[[i]]$daily_obj
  big_table_6928 <- cbind(big_table_6928,current)
}
print(sum(is.na(big_table_6928)))

# xts_6928 <- xts(six_nine_two_eight,order.by = six_nine_two_eight$DateTime)
# 
# summary(xts_6928)
# 
# daily_6928 <- to.daily(xts_6928$subzone, OHLC=F,)
# weekly_6928 <- to.weekly(xts_6928$subzone, OHLC=F)
# monthly_6928 <- to.monthly(xts_6928$subzone, OHLC=F)
# index(monthly_6928) <-as.POSIXct(index(monthly_6928))
# 
# length(daily_6928)

#six_nine_two_eight_daily <- calc_trans_period("6928",daily_6928,xts_6928,"d")

#six_nine_two_eight_weekly <- calc_trans_period("6928",weekly_6928,xts_6928,"w")

#six_nine_two_eight_monthly <- calc_trans_period("6928",monthly_6928,xts_6928,"m")

#write.csv(six_nine_two_eight_daily,"6928_daily.csv",row.names = F)
#write.csv(six_nine_two_eight_weekly,"6928_weekly.csv",row.names=F)
#write.csv(six_nine_two_eight_monthly,"6928_monthly.csv",row.names=F)

```


```{r, generate transition tables for 6988}
#65524
six_nine_eight_eight <- read.csv("6988.csv")

bird_ids_6988 <- unique(six_nine_eight_eight$tagname)
bird_ids_6988 <- na.trim(sort(bird_ids_6988))

six_nine_eight_eight["DateTime"] <- as.POSIXct(six_nine_eight_eight$access, origin="1970-01-01", tz="GMT")

unique(six_nine_eight_eight$subzone)

six_nine_eight_eight$subzone[six_nine_eight_eight$subzone == "Bottom"] <- "bottom"
six_nine_eight_eight$subzone[six_nine_eight_eight$subzone == "Middle"] <- "middle"
six_nine_eight_eight$subzone[six_nine_eight_eight$subzone == "Top"] <- "top"

#65475
unique(six_nine_eight_eight$subzone)

sum(is.na(six_nine_eight_eight$DateTime))
sum(is.na(six_nine_eight_eight$subzone))


#generate list of XTS objects 
reslist_6988 <- list()
for(i in 1:length(bird_ids_6988)){
  
  res <- sep_bird_id_xts(samp_name="6988",cage_obj =six_nine_eight_eight, samp_id = bird_ids_6988[i])
  reslist_6988[[i]] <- res
}

#summarize the xts objects to find a period of time that 
for(item in reslist_6988){
  print(item$ID)
  print(summary(item$xts_obj))
}

remove <- c("6910","6914","9005")
bird_ids_6988_new <- bird_ids_6988 [! bird_ids_6988  %in% remove ]
#generate list of the first 10 truncated XTS objects
reslist2_6988 <- list()
for(i in 1:length(bird_ids_6988_new)){
  res <- sep_bird_id_period(samp_name="6988",cage_obj =six_nine_eight_eight, samp_id = bird_ids_6988_new[i],cutoff = "2021-02-18 T16:00:00/2021-05-05 T23:00:00")
  reslist2_6988[[i]] <- res
}

#summarize the xts objects to check that the truncation worked
for(item in reslist2_6988){
  print(item$ID)
  print(summary(item$xts_obj))
  print(item$daily_obj)
}

#find wholly non-na daily timeset, to be able to feed into the transcalc
big_table_6988 <- reslist2_6988[[1]]$daily_obj
for(i in 2:length(reslist2_6988)){
  current <- reslist2_6988[[i]]$daily_obj
  big_table_6988 <- cbind(big_table_6988,current)
}
print(sum(is.na(big_table_6988)))

sum(is.na(cbind(big_table_2_6894,big_table_6928,big_table_6988)))

# xts_6988 <- xts(six_nine_eight_eight,order.by = six_nine_eight_eight$DateTime)
# 
# summary(xts_6988)
# 
# daily_6988 <- to.daily(xts_6988$subzone, OHLC=F,)
# weekly_6988 <- to.weekly(xts_6988$subzone, OHLC=F)
# monthly_6988 <- to.monthly(xts_6988$subzone, OHLC=F)
# index(monthly_6988) <-as.POSIXct(index(monthly_6988))
# 
# length(daily_6988)
# 
# six_nine_eight_eight_daily <- calc_trans_period("6988",daily_6988,xts_6988,"d")
# 
# six_nine_eight_eight_weekly <- calc_trans_period("6988",weekly_6988,xts_6988,"w")
# 
# six_nine_eight_eight_monthly <- calc_trans_period("6988",monthly_6988,xts_6988,"m")
# 
# write.csv(six_nine_eight_eight_daily,"6988_daily.csv",row.names = F)
# write.csv(six_nine_eight_eight_weekly,"6988_weekly.csv",row.names=F)
# write.csv(six_nine_eight_eight_monthly,"6988_monthly.csv",row.names=F)

```

```{r}
#65495
nine_zero_one_three <- read.csv("9013.csv")

bird_ids_9013 <- unique(nine_zero_one_three$tagname)
bird_ids_9013 <- na.trim(sort(bird_ids_9013))

nine_zero_one_three["DateTime"] <- as.POSIXct(nine_zero_one_three$access, origin="1970-01-01", tz="GMT")

unique(nine_zero_one_three$subzone)

nine_zero_one_three$subzone[nine_zero_one_three$subzone == "Bottom"] <- "bottom"
nine_zero_one_three$subzone[nine_zero_one_three$subzone == "Middle"] <- "middle"
nine_zero_one_three$subzone[nine_zero_one_three$subzone == "Top"] <- "top"

#65495
unique(nine_zero_one_three$subzone)

sum(is.na(nine_zero_one_three$DateTime))
sum(is.na(nine_zero_one_three$subzone))


#generate list of XTS objects 
reslist_9013 <- list()
for(i in 1:length(bird_ids_9013)){
  
  res <- sep_bird_id_xts(samp_name="9013",cage_obj =nine_zero_one_three, samp_id = bird_ids_9013[i])
  reslist_9013[[i]] <- res
}

#summarize the xts objects to find a period of time that 
for(item in reslist_9013){
  print(item$ID)
  print(summary(item$xts_obj))
}

remove <- c("6998")
bird_ids_9013_new <- bird_ids_9013 [! bird_ids_9013  %in% remove ]
#generate list of the first 10 truncated XTS objects
reslist2_9013 <- list()
for(i in 1:length(bird_ids_9013_new)){
  res <- sep_bird_id_period(samp_name="9013",cage_obj =nine_zero_one_three, samp_id = bird_ids_9013_new[i],cutoff = "2021-03-09 T18:00:00/2021-05-07 T17:00:00")
  reslist2_9013[[i]] <- res
}

#summarize the xts objects to check that the truncation worked
for(item in reslist2_9013){
  print(item$ID)
  print(summary(item$xts_obj))
  print(item$daily_obj)
}

#find wholly non-na daily timeset, to be able to feed into the transcalc
big_table_9013 <- reslist2_9013[[1]]$daily_obj
for(i in 2:length(reslist2_9013)){
  current <- reslist2_9013[[i]]$daily_obj
  big_table_9013 <- cbind(big_table_9013,current)
}
print(sum(is.na(big_table_9013)))

sum(is.na(cbind(big_table_2_6894,big_table_6928,big_table_6988)))
# 
# xts_9013 <- xts(nine_zero_one_three,order.by = nine_zero_one_three$DateTime)
# 
# summary(xts_9013)
# 
# daily_9013 <- to.daily(xts_9013$subzone, OHLC=F,)
# weekly_9013 <- to.weekly(xts_9013$subzone, OHLC=F)
# monthly_9013 <- to.monthly(xts_9013$subzone, OHLC=F)
# index(monthly_9013) <-as.POSIXct(index(monthly_9013))
# 
# length(daily_9013)
# 
# nine_zero_one_three_daily <- calc_trans_period("9013",daily_9013,xts_9013,"d")
# 
# nine_zero_one_three_weekly <- calc_trans_period("9013",weekly_9013,xts_9013,"w")
# 
# nine_zero_one_three_monthly <- calc_trans_period("9013",monthly_9013,xts_9013,"m")
# 
# write.csv(nine_zero_one_three_daily,"9013_daily.csv",row.names = F)
# write.csv(nine_zero_one_three_weekly,"9013_weekly.csv",row.names=F)
# write.csv(nine_zero_one_three_monthly,"9013_monthly.csv",row.names=F)


```



```{r, try out LDA with the Iris example}
library(MASS)
Iris <- data.frame(rbind(iris3[,,1], iris3[,,2], iris3[,,3]),Sp = rep(c("s","c","v"), rep(50,3)))
train <- sample(1:150, 75)
table(Iris$Sp[train])

z <- lda(Sp ~ ., Iris, prior = c(1,1,1)/3, subset = train)
predict(z, Iris[-train, ])$class

(z1 <- update(z, . ~ . - Petal.W.))


```