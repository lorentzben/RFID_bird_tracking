---
title: "RFID Room 2"
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
---


# Data Preprocessing

## Function to find the most frequent zone (average wont quite work)

```{r find most frequent zone}
MaxTable <- function(x){
     dd <- unique(x)
     dd[which.max(tabulate(match(x,dd)))]
}

```

## My to minute function

```{r my to minute}
to_minute <- function(xts_object){
  ep_min <- endpoints(na.omit(xts_object), on="minutes",k=60)
  ave_min <- period.apply(na.omit(xts_object), INDEX=ep_min, FUN=MaxTable)
  #this removes the time to allow cbinding
  ave_min <- to.minutes(ave_min,OHLC=F,indexAt="startof")
  return(ave_min)
}
```

## My to daily function

```{r my to daily}
 to_daily <- function(xts_object){
   ep_day <- endpoints(na.omit(xts_object), on="minutes",k=1440)
   ave_day <- period.apply(na.omit(xts_object), INDEX=ep_day, FUN=MaxTable)
   #this removes the time to allow cbinding
   ave_day <- to.daily(ave_day,OHLC=F,indexAt="startof")
   return(ave_day)
 }
```

## My to weekly function

```{r my to weekly}
to_weekly <- function(xts_object){
  ep_week <- endpoints(na.omit(xts_object), on="minutes",k=10080)
  ave_week <- period.apply(na.omit(xts_object), INDEX=ep_week, FUN=MaxTable)
  #this removes the time to allow cbinding
  ave_week <- to.weekly(ave_week,OHLC=F,indexAt="startof")
  return(ave_week)
}
```

## My to monthly function

```{r my to monthly}
to_monthly <- function(xts_object){
  ep_month <- endpoints(na.omit(xts_object), on="minutes",k=43800)
  ave_month <- period.apply(na.omit(xts_object), INDEX=ep_month, FUN=MaxTable)
  #this removes the time to allow cbinding
  ave_month <- to.monthly(ave_month,OHLC=F,indexAt="startof")
  return(ave_month)
}
```


## Function to Calculate Transitions

```{r function to calc transitions}
#I don't know when we use this data yet, will be useful when making transition tables for the whole dataset 
sep_bird_id_xts <- function(samp_name, samp_id,cage_obj){
  
  raw_sample_tab <- subset(cage_obj, tagname==samp_id)
  
  xts_object <- xts(raw_sample_tab ,order.by = raw_sample_tab$DateTime)
  
  result <- list("name" = samp_name, "ID"=samp_id, "xts_obj"=xts_object)
  return(result)
}

sep_bird_id_period <- function(samp_name, samp_id, cage_obj, cutoff){
  
  raw_sample_tab <- subset(cage_obj, tagname==samp_id)
  
  xts_object <- xts(raw_sample_tab ,order.by=raw_sample_tab$DateTime)
  
  xts_object <- xts_object[cutoff]
  
  daily <- to_daily(xts_object$subzone)#, OHLC=F)
  weekly <- to_weekly(xts_object$subzone)#, OHLC=F)
  monthly <- to_monthly(xts_object$subzone)#, OHLC=F)
  index(monthly) <-as.POSIXct(index(monthly))
  
  result <- list("name" = samp_name, "ID"=samp_id, "xts_obj"=xts_object, "daily_obj"=daily,
                 "weekly_obj"=weekly, "monthly_obj"=monthly)
  return(result)
}

#input a sample name
#returns a vector labeled with sample name, and bottom, middle, top and total transitions

calc_trans<- function(samp_name,samp_obj, id){
  bottom_trans <-0
  mid_trans<-0
  top_trans<-0
  trans<-0
  count <- 0
  
  for (i in 2:length(samp_obj$subzone)) {
  previous_state <- as.character(samp_obj$subzone[i-1])
  current_state <- as.character(samp_obj$subzone[i])
  
  #print(paste(previous_state,":",current_state))
  
  
  if (previous_state == current_state) {
    count <- count+1
  }
  else{
    
    if((current_state == "bottom") || (current_state == "Bottom")){
      bottom_trans <- bottom_trans+1
      trans<- trans+1
    }
    if (current_state=="middle" || current_state == "Middle") {
      mid_trans <- mid_trans+1
      trans <- trans+1
    }
    if(current_state =="top" || current_state=="Top"){
      top_trans <- top_trans+1
      trans <- trans+1
    }
  }
  }
  
  result <- c(samp_name,id,bottom_trans,mid_trans,top_trans,trans)
  return(result)
  
}

calc_trans_period<- function(samp_name, daily_indexed, raw_table,freq, day_offset){
  result <- data.frame()
  
  for (i in 2:(length(daily_indexed))){
    curr_day <- raw_table[paste0(index(daily_indexed)[i-1],"/",index(daily_indexed)[i])]
    curr_day_trans <- calc_trans(paste0(samp_name,".",index(daily_indexed)[i-1]),curr_day, samp_name)
    result <- rbind(result,curr_day_trans)
    }
  colnames(result) <- c("sample","ID","bottom","mid","top","total")
  return(result)
}
```

```{r my calc trans duration function}

calc_trans_duration<- function(samp_name,samp_obj, id){
  bottom_trans <-0
  mid_trans<-0
  top_trans<-0
  trans<-0
  count <- 0
  bottom_time <- 0 
  mid_time <- 0
  top_time <- 0
  
  for (i in 2:length(samp_obj$subzone)) {
  previous_state <- as.character(samp_obj$subzone[i-1])
  current_state <- as.character(samp_obj$subzone[i])
  previous_time <- index(samp_obj[i-1])
  current_time <- index(samp_obj[i])
  
  #print(paste(previous_state,":",current_state))
  
  
  if (previous_state == current_state) {
    count <- count+1
  }
  else{
    
    if((previous_state == "bottom") || (previous_state == "Bottom")){
      bottom_trans <- bottom_trans+1
      trans<- trans+1
      bottom_time <- bottom_time + difftime(current_time, previous_time,units="secs")
    }
    if (previous_state=="middle" || previous_state == "Middle") {
      mid_trans <- mid_trans+1
      trans <- trans+1
      mid_time <- mid_time + difftime(current_time, previous_time, units="secs")
    }
    if(previous_state =="top" || previous_state=="Top"){
      top_trans <- top_trans+1
      trans <- trans+1
      top_time <- top_time + difftime(current_time,previous_time,units="secs")
    }
  }
  }
  
  result <- c(samp_name,id,bottom_trans,mid_trans,top_trans,trans,bottom_time,mid_time,top_time)
  #colnames(result) <- c("sample_name","ID","bottom_trans","middle_trans","top_trans","total_trans","bottom_sec","mid_sec","top_sec")
  return(result)
  
}

calc_trans_period_duration<- function(samp_name, daily_indexed, raw_table,freq,day_offset ){
  result <- data.frame()
  
  for (i in 2:(length(daily_indexed))){
    curr_day <- raw_table[paste0(index(daily_indexed)[i-1],"/",index(daily_indexed)[i])]
    curr_day_trans <- calc_trans_duration(paste0(samp_name,".",freq,".",(i+day_offset)),curr_day, samp_name)
    result <- rbind(result,curr_day_trans)
    }
  colnames(result) <- c("sample_name","ID","bottom_trans","middle_trans","top_trans","total_trans","bottom_sec","mid_sec","top_sec")
  return(result)
}
```

```{r calculate duration spent in each zone}

calc_zone_duration <- function(samp_name, id, samp_obj){
  bottom_time <- 0
  mid_time <- 0 
  top_time <- 0

  current_zone <- ""
  current_datetime <- ""
  next_datetime <- ""

  for(i in 1:(length(index(samp_obj))-1)){

    current_zone <- as.character(samp_obj[i]$subzone)

    #this is measured in seconds
    sec_in_zone_i <- as.numeric(index(samp_obj[i+1]$accessdate)) - as.numeric(index(samp_obj[i]$accessdate))

    if(current_zone == "bottom"){
      bottom_time <- bottom_time + sec_in_zone_i
      sec_in_zone_i <- 0
    } else if(current_zone == "middle"){
      mid_time <- mid_time + sec_in_zone_i
      sec_in_zone_i <- 0
    } else if(current_zone == "top"){
      top_time <- top_time + sec_in_zone_i
      sec_in_zone_i <- 0
    }

  }

  return(c(samp_name, id, as.numeric(bottom_time), as.numeric(mid_time), as.numeric(top_time)))

}

```

## Import Room 2

```{r generate transition tables for room 2}

library(xts)
room_2 <- read.csv("../data/DK20-03-RFID-R2-febmay-080423.csv")

bird_ids_room_2 <- unique(room_2$tagname)
bird_ids_room_2 <- na.trim(sort(bird_ids_room_2))

room_2["DateTime"] <- as.POSIXct(room_2$access, origin="1970-01-01", tz="GMT")

print("what makes up subzone col")
unique(room_2$subzone)

room_2$subzone[room_2$subzone == "Bottom"] <- "bottom"
room_2$subzone[room_2$subzone == "Middle"] <- "middle"
room_2$subzone[room_2$subzone == "Top"] <- "top"

#65475
print("what makes up subzone col")
unique(room_2$subzone)

print("how many NAs in DateTime and Subzone")
sum(is.na(room_2$DateTime))
sum(is.na(room_2$subzone))


#generate list of XTS objects 
reslist_room_2 <- list()
for(i in 1:length(bird_ids_room_2)){
  
  res <- sep_bird_id_xts(samp_name="room 2",cage_obj =room_2, samp_id = bird_ids_room_2[i])
  reslist_room_2[[i]] <- res
}

cutoff_room_2 <- data.frame()
for(i in 1:length(reslist_room_2)){
  id <- reslist_room_2[[i]]$ID
  top <- index(head(reslist_room_2[[i]]$xts_obj))[1]
  bottom <- index(tail(reslist_room_2[[i]]$xts_obj))[6]
  rec <- cbind(id,as.character(top),as.character(bottom))
  cutoff_room_2 <- rbind(cutoff_room_2,rec)
  
}

#head
cutoff_room_2[order(cutoff_room_2$V2),]
#tail
cutoff_room_2[order(cutoff_room_2$V3),]



#remove <- c("6910","6914","9005")
remove <- c("6910","6966","6914")
bird_ids_room_2_new <- bird_ids_room_2 [! bird_ids_room_2  %in% remove ]
#generate list of the first 10 truncated XTS objects
reslist2_room_2 <- list()
for(i in 1:length(bird_ids_room_2_new)){
  res <- sep_bird_id_period(samp_name="room 2",cage_obj =room_2, samp_id = bird_ids_room_2_new[i],cutoff = "2021-03-09 T20:00:00/2021-05-06 T23:00:00")
  reslist2_room_2[[i]] <- res
}

#find wholly non-na daily timeset, to be able to feed into the transcalc
big_table_room_2 <- reslist2_room_2[[1]]$daily_obj
for(i in 2:length(reslist2_room_2)){
  current <- reslist2_room_2[[i]]$daily_obj
  colnames(current) <- as.character(reslist2_room_2[[i]]$ID)
  big_table_room_2 <- cbind(big_table_room_2,current)
}
print("How many NAs in big_table_room_2")
print(sum(is.na(big_table_room_2)))
```

## Import Room 3

```{r import room 3}
library(xts)
library(tidyverse)

room_3 <- read.csv("../data/DK20-03-RFID-R3-febmay-080423.csv") %>% na.exclude()

bird_ids_room_3 <- unique(room_3$tagname)
bird_ids_room_3 <- na.trim(sort(bird_ids_room_3))

room_3["DateTime"] <- as.POSIXct(room_3$access, origin="1970-01-01", tz="GMT")

print("what makes up subzone col")
unique(room_3$subzone)

room_3$subzone[room_3$subzone == "Bottom"] <- "bottom"
room_3$subzone[room_3$subzone == "Middle"] <- "middle"
room_3$subzone[room_3$subzone == "Top"] <- "top"


print("what makes up subzone col")
unique(room_3$subzone)

print("how many NA's are in Datetime and Subzone")
sum(is.na(room_3$DateTime))
sum(is.na(room_3$subzone))

room_3 <- room_3[!is.na(room_3$DateTime),]

print("how many NA's are in Datetime and Subzone")
sum(is.na(room_3$DateTime))
sum(is.na(room_3$subzone))


#generate list of XTS objects 
reslist_room_3 <- list()
for(i in 1:length(bird_ids_room_3)){
  
  res <- sep_bird_id_xts(samp_name="room_3",cage_obj =room_3, samp_id = bird_ids_room_3[i])
  reslist_room_3[[i]] <- res
}



cutoff_room_3 <- data.frame()
for(i in 1:length(reslist_room_3)){
  id <- reslist_room_3[[i]]$ID
  top <- index(head(reslist_room_3[[i]]$xts_obj))[1]
  bottom <- index(tail(reslist_room_3[[i]]$xts_obj))[6]
  rec <- cbind(id,as.character(top),as.character(bottom))
  cutoff_room_3 <- rbind(cutoff_room_3,rec)
  
}

#head
cutoff_room_3[order(cutoff_room_3$V2),]
#tail
cutoff_room_3[order(cutoff_room_3$V3),]


#remove <- c("6998")
remove <- c("6915","9008","6912","6987","6948","6953","6879","6968","9029")
bird_ids_room_3_new <- bird_ids_room_3 [! bird_ids_room_3  %in% remove ]
#generate list of the first 10 truncated XTS objects
reslist2_room_3 <- list()
for(i in 1:length(bird_ids_room_3_new)){
  res <- sep_bird_id_period(samp_name="room 3",cage_obj=room_3, samp_id =bird_ids_room_3_new[i],cutoff = "2021-03-09 T20:00:00/2021-05-06 T23:00:00")
  #print(res)

  reslist2_room_3[[i]] <- res
}



#find wholly non-na daily timeset, to be able to feed into the transcalc
big_table_room_3 <- reslist2_room_3[[1]]$daily_obj
for(i in 2:length(reslist2_room_3)){
  current <- reslist2_room_3[[i]]$daily_obj
  big_table_room_3 <- cbind(big_table_room_3,current)
}
print("how many NA's are in big_table_room_3")
print(sum(is.na(big_table_room_3)))
```

## Import Room 8

```{r import Room 8}
library(xts)

room_8 <- read.csv("../data/DK20-03-RFID-r8-febmay-080423.csv")

bird_ids_room_8 <- na.trim(unique(room_8$tagname))
bird_ids_room_8 <- sort(bird_ids_room_8)

room_8["DateTime"] <- as.POSIXct(room_8$access, origin="1970-01-01", tz="GMT")

print("what makes up subzone col")
unique(room_8$subzone)

room_8$subzone[room_8$subzone == "Bottom"] <- "bottom"
room_8$subzone[room_8$subzone == "middle"] <- "middle"
room_8$subzone[room_8$subzone == "Top"] <- "top"
room_8 <-subset(room_8, subzone!="test")

print("what makes up subzone col")
unique(room_8$subzone)

print("how many NA's in Datetime and Subzone")
sum(is.na(room_8$DateTime))
sum(is.na(room_8$subzone))

#generate list of XTS objects 
reslist_room_8 <- list()
for(i in 1:length(bird_ids_room_8)){
  
  res <- sep_bird_id_xts(samp_name="room 8",cage_obj =room_8, samp_id = bird_ids_room_8[i])
  reslist_room_8[[i]] <- res
}

cutoff_room_8 <- data.frame()
for(i in 1:length(reslist_room_8)){
  id <- reslist_room_8[[i]]$ID
  top <- index(head(reslist_room_8[[i]]$xts_obj))[1]
  bottom <- index(tail(reslist_room_8[[i]]$xts_obj))[6]
  rec <- cbind(id,as.character(top),as.character(bottom))
  cutoff_room_8 <- rbind(cutoff_room_8,rec)
  
}

#head
cutoff_room_8[order(cutoff_room_8$V2),]
#tail
cutoff_room_8[order(cutoff_room_8$V3),]

remove <-c("6949","6936","6974","9009","9011","6995")
bird_ids_room_8_new <- bird_ids_room_8 [! bird_ids_room_8  %in% remove ]
#generate list of the first 10 truncated XTS objects
reslist2_room_8 <- list()
for(i in 1:length(bird_ids_room_8_new)){
  res <- sep_bird_id_period(samp_name="room 8",cage_obj =room_8, samp_id = bird_ids_room_8_new[i],cutoff = "2021-03-09 T20:00:00/2021-05-06 T23:00:00")
  reslist2_room_8[[i]] <- res
}

#find wholly non-na daily timeset, to be able to feed into the transcalc
big_table_room_8 <- reslist2_room_8[[1]]$daily_obj
for(i in 2:length(reslist2_room_8)){
  current <- reslist2_room_8[[i]]$daily_obj
  big_table_room_8 <- cbind(big_table_room_8,current)
}
print("how many NA's in big_table_room_8")
print(sum(is.na(big_table_room_8)))
```

## Import Room 11

```{r import Room 11}
library(xts)

room_11 <- read.csv("../data/DK20-03-RFID-R11-febmay-080423.csv")

bird_ids_room_11 <- na.trim(unique(room_11$tagname))
bird_ids_room_11 <- sort(bird_ids_room_11)

room_11 <- room_11[order(room_11$access),] 

room_11["DateTime"] <- as.POSIXct(room_11$access, origin="1970-01-01", tz="GMT")

print("what composes the subzone column")
unique(room_11$subzone)

room_11$subzone[room_11$subzone == "M"] <- "middle"
room_11$subzone[room_11$subzone == "B"] <- "bottom"
room_11$subzone[room_11$subzone == "T"] <- "top"

print("what composes the subzone column")
unique(room_11$subzone)

print("how many NA's in the DateTime col")
sum(is.na(room_11$DateTime))

room_11 <- room_11[!is.na(room_11$DateTime),]

print("how many NA's in the Datetime col")
sum(is.na(room_11$DateTime))

#generate list of XTS objects 
reslist_room_11 <- list()
for(i in 1:length(bird_ids_room_11)){
  
  res <- sep_bird_id_xts(samp_name="room 11",cage_obj =room_11, samp_id = bird_ids_room_11[i])
  reslist_room_11[[i]] <- res
}

# index 10 is an error right now, how can we fix na value

remove <- c("6888")

cutoff_room_11 <- data.frame()
for(i in 1:length(reslist_room_11)){
  print(i)
  id <- reslist_room_11[[i]]$ID
  if(id %in% remove){
  } else{
    top <- index(head(reslist_room_11[[i]]$xts_obj))[1]
    bottom <- index(tail(reslist_room_11[[i]]$xts_obj))[6]
    rec <- cbind(id,as.character(top),as.character(bottom))
    cutoff_room_11 <- rbind(cutoff_room_11,rec)
  }
}

#head
cutoff_room_11[order(cutoff_room_11$V2),]
#tail
cutoff_room_11[order(cutoff_room_11$V3),]

 

remove <- c("6888","6868","6880","6881","6893","6892", "6894","6862","6898","6882","6899","6887","6896","6889","6895","6885","6900","6897","6891","6884","6906","6920","6954","6991","6930","9059","9060")
bird_ids_room_11_new <- bird_ids_room_11 [! bird_ids_room_11  %in% remove ]
#generate list of the first 10 truncated XTS objects
reslist2_room_11 <- list()
for(i in 1:length(bird_ids_room_11_new)){
  res <- sep_bird_id_period(samp_name="room 11",cage_obj =room_11, samp_id = bird_ids_room_11_new[i], cutoff="2021-03-09 T20:00:00/2021-05-06 T23:00:00")
  reslist2_room_11[[i]] <- res
}


#find wholly non-na daily timeset, to be able to feed into the transcalc
big_table_room_11 <- reslist2_room_11[[1]]$daily_obj
for(i in 2:length(reslist2_room_11)){
  current <- reslist2_room_11[[i]]$daily_obj
  big_table_room_11 <- cbind(big_table_room_11,current)
}
print("Na's in big_table_room_11")
print(sum(is.na(big_table_room_11)))
print("top of big_table_room_11")
print(head(big_table_room_11))
```

# Intra-Bird Analysis With All Rooms

```{r }
trans_reslist_room_2 <- list()

for(i in 1:length(reslist2_room_2)){
  
  daily_trans_table <- calc_trans_period(reslist2_room_2[[i]]$ID,reslist2_room_2[[i]]$daily_obj,reslist2_room_2[[i]]$xts_obj,"d", 0)
  weekly_trans_table <- calc_trans_period(reslist2_room_2[[i]]$ID,reslist2_room_2[[i]]$weekly_obj,reslist2_room_2[[i]]$xts_obj,"w", 0)
  monthly_trans_table <- calc_trans_period(reslist2_room_2[[i]]$ID,reslist2_room_2[[i]]$monthly_obj,reslist2_room_2[[i]]$xts_obj,"m",0)
    
  result <- list("ID"=reslist2_room_2[[i]]$ID,"daily"=daily_trans_table, "weekly"=weekly_trans_table,"monthly"=monthly_trans_table, "raw"=reslist2_room_2[[i]]$xts_obj)
  trans_reslist_room_2[[i]] <- result
}

room_2_daily <- data.frame()
room_2_weekly <- data.frame()
room_2_monthly <- data.frame()
#TODO select sample as opposed to ID for intra bird comparison (alpha eq)
for(item in trans_reslist_room_2){
  room_2_daily <- rbind(room_2_daily, item$daily[c("sample","bottom","mid","top","total")])
  room_2_weekly <- rbind(room_2_weekly, item$weekly[c("sample","bottom","mid","top","total")])
  room_2_monthly <- rbind(room_2_monthly, item$monthly[c("sample","bottom","mid","top","total")])
}

# check to make sure only one bird is selected
print("check that the id and RFID tag are unique for each item entry")
#this is following up with the issues of the intra-bird comparisons
for(item in trans_reslist_room_2){
  print(paste(unique(item$raw$Tagnumber)," ",unique(item$raw$tagname)))
  #print(item)
}

trans_reslist_room_3 <- list()
for(i in 1:length(reslist2_room_3)){
  
  daily_trans_table <- calc_trans_period(reslist2_room_3[[i]]$ID,reslist2_room_3[[i]]$daily_obj,reslist2_room_3[[i]]$xts_obj,"d",0)
  weekly_trans_table <- calc_trans_period(reslist2_room_3[[i]]$ID,reslist2_room_3[[i]]$weekly_obj,reslist2_room_3[[i]]$xts_obj,"w",0)
  monthly_trans_table <- calc_trans_period(reslist2_room_3[[i]]$ID,reslist2_room_3[[i]]$monthly_obj,reslist2_room_3[[i]]$xts_obj,"m",0)
    
  result <- list("ID"=reslist2_room_3[[i]]$ID,"daily"=daily_trans_table, "weekly"=weekly_trans_table,"monthly"=monthly_trans_table, "raw"=reslist2_room_3[[i]]$xts_obj)
  trans_reslist_room_3[[i]] <- result
}

room_3_daily <- data.frame()
room_3_weekly <- data.frame()
room_3_monthly <- data.frame()
#TODO select sample as opposed to ID for intra bird comparison (alpha eq)
for(item in trans_reslist_room_3){
  room_3_daily <- rbind(room_3_daily, item$daily[c("sample","bottom","mid","top","total")])
  room_3_weekly <- rbind(room_3_weekly, item$weekly[c("sample","bottom","mid","top","total")])
  room_3_monthly <- rbind(room_3_monthly, item$monthly[c("sample","bottom","mid","top","total")])
}

# check to make sure only one bird is selected
print("check that the id and RFID tag are unique for each item entry")
#this is following up with the issues of the intra-bird comparisons
for(item in trans_reslist_room_3){
  print(paste(unique(item$raw$Tagnumber)," ",unique(item$raw$tagname)))
  #print(item)
}

trans_reslist_room_8 <- list()

for(i in 1:length(reslist2_room_8)){
  
  daily_trans_table <- calc_trans_period(reslist2_room_8[[i]]$ID,reslist2_room_8[[i]]$daily_obj,reslist2_room_8[[i]]$xts_obj,"d",0)
  weekly_trans_table <- calc_trans_period(reslist2_room_8[[i]]$ID,reslist2_room_8[[i]]$weekly_obj,reslist2_room_8[[i]]$xts_obj,"w",0)
  monthly_trans_table <- calc_trans_period(reslist2_room_8[[i]]$ID,reslist2_room_8[[i]]$monthly_obj,reslist2_room_8[[i]]$xts_obj,"m",0)
    
  result <- list("ID"=reslist2_room_8[[i]]$ID,"daily"=daily_trans_table, "weekly"=weekly_trans_table,"monthly"=monthly_trans_table, "raw"=reslist2_room_8[[i]]$xts_obj)
  trans_reslist_room_8[[i]] <- result
}

room_8_daily <- data.frame()
room_8_weekly <- data.frame()
room_8_monthly <- data.frame()
#TODO select sample as opposed to ID for intra bird comparison (alpha eq)
for(item in trans_reslist_room_8){
  room_8_daily <- rbind(room_8_daily, item$daily[c("sample","bottom","mid","top","total")])
  room_8_weekly <- rbind(room_8_weekly, item$weekly[c("sample","bottom","mid","top","total")])
  room_8_monthly <- rbind(room_8_monthly, item$monthly[c("sample","bottom","mid","top","total")])
}

# check to make sure only one bird is selected
print("check that the id and RFID tag are unique for each item entry")
#this is following up with the issues of the intra-bird comparisons
for(item in trans_reslist_room_8){
  print(paste(unique(item$raw$tagnumber)," ",unique(item$raw$tagname)))
  #print(item)
}

trans_reslist_room_11 <- list()

for(i in 1:length(reslist2_room_11)){
  
  daily_trans_table <- calc_trans_period(reslist2_room_11[[i]]$ID,reslist2_room_11[[i]]$daily_obj,reslist2_room_11[[i]]$xts_obj,"d")
  weekly_trans_table <- calc_trans_period(reslist2_room_11[[i]]$ID,reslist2_room_11[[i]]$weekly_obj,reslist2_room_11[[i]]$xts_obj,"w")
  monthly_trans_table <- calc_trans_period(reslist2_room_11[[i]]$ID,reslist2_room_11[[i]]$monthly_obj,reslist2_room_11[[i]]$xts_obj,"m")
    
  result <- list("ID"=reslist2_room_11[[i]]$ID,"daily"=daily_trans_table, "weekly"=weekly_trans_table,"monthly"=monthly_trans_table, "raw"=reslist2_room_11[[i]]$xts_obj)
  trans_reslist_room_11[[i]] <- result
}

room_11_daily <- data.frame()
room_11_weekly <- data.frame()
room_11_monthly <- data.frame()
#TODO select sample as opposed to ID for intra bird comparison (alpha eq)
for(item in trans_reslist_room_11){
  room_11_daily <- rbind(room_11_daily, item$daily[c("sample","bottom","mid","top","total")])
  room_11_weekly <- rbind(room_11_weekly, item$weekly[c("sample","bottom","mid","top","total")])
  room_11_monthly <- rbind(room_11_monthly, item$monthly[c("sample","bottom","mid","top","total")])
}

# check to make sure only one bird is selected
print("check that the id and RFID tag are unique for each item entry")
#this is following up with the issues of the intra-bird comparisons
for(item in trans_reslist_room_11){
  print(paste(unique(item$raw$tagnumber)," ",unique(item$raw$tagname)))
  #print(item)
}

# w <- 0
# for(item in trans_reslist_room_2){
#   w <- w +1
#   print(w)
# }
# w <- 0
# for(item in trans_reslist_room_3){
#   w <- w +1
#   print(w)
# }
# w <- 0
# for(item in trans_reslist_room_8){
#   w <- w +1
#   print(w)
# }
# w <- 0
# for(item in trans_reslist_room_11){
#   w <- w +1
#   print(w)
# }
#write.csv(room_2_daily,"room_2_daily_intra.csv",row.names = F)
#write.csv(room_2_weekly,"room_2_weekly_intra.csv",row.names = F)
#write.csv(room_2_monthly,"room_2_monthly_intra.csv",row.names = F)

```


## Determine which bird is the most active in the Whole Dataset

```{r who is the most active in whole dataset?}
daily <- data.frame()
weekly <- data.frame()
monthly <- data.frame()
#TODO select sample as opposed to ID for intra bird comparison (alpha eq)
for(item in trans_reslist_room_2){
  daily <- rbind(daily, item$daily[c("ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("ID","bottom","mid","top","total")])
}
length(unique(daily$ID))
for(item in trans_reslist_room_3){
  daily <- rbind(daily, item$daily[c("ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("ID","bottom","mid","top","total")])
}
length(unique(daily$ID))
for(item in trans_reslist_room_8){
  daily <- rbind(daily, item$daily[c("ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("ID","bottom","mid","top","total")])
}
length(unique(daily$ID))
for(item in trans_reslist_room_11){
  daily <- rbind(daily, item$daily[c("ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("ID","bottom","mid","top","total")])
}
length(unique(daily$ID))

tmp <- ""
tmp_df <- ""
tmp <- cbind(as.character(daily$ID), as.numeric(daily$total))
tmp_df <- data.frame(as.numeric(tmp[,1]), as.numeric(tmp[,2]))
colnames(tmp_df) <- c("ID","total")
transitions <- aggregate(total ~ ID, data=tmp_df, FUN=sum)
days <- table(tmp_df$ID)
norm_tots <- round(transitions$total/days,0)
norm_tots_df <- data.frame(norm_tots)
norm_tots_df <- data.frame(as.character(norm_tots_df$Var1), as.numeric(norm_tots_df$Freq))
colnames(norm_tots_df) <-c("ID","norm_tot")
most_active <- norm_tots_df$ID[norm_tots_df$norm_tot == max(norm_tots_df$norm_tot)]

print(paste("Most active bird: ",most_active))
```

## Determine which bird is the least active in the Room 2 Dataset

```{r who is the least active in whole dataset?}
daily <- data.frame()
weekly <- data.frame()
monthly <- data.frame()
#TODO select sample as opposed to ID for intra bird comparison (alpha eq)
for(item in trans_reslist_room_2){
  daily <- rbind(daily, item$daily[c("ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("ID","bottom","mid","top","total")])
}
for(item in trans_reslist_room_3){
  daily <- rbind(daily, item$daily[c("ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("ID","bottom","mid","top","total")])
}
for(item in trans_reslist_room_8){
  daily <- rbind(daily, item$daily[c("ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("ID","bottom","mid","top","total")])
}
for(item in trans_reslist_room_11){
  daily <- rbind(daily, item$daily[c("ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("ID","bottom","mid","top","total")])
}

tmp  <- ""
tmp_df <- ""

tmp <- cbind(as.character(daily$ID), as.numeric(daily$total))
tmp_df <- data.frame(as.numeric(tmp[,1]), as.numeric(tmp[,2]))
colnames(tmp_df) <- c("ID","total")
transitions <- aggregate(total ~ ID, data=tmp_df, FUN=sum)
days <- table(tmp_df$ID)
norm_tots <- round(transitions$total/days,0)
norm_tots_df <- data.frame(norm_tots)
norm_tots_df <- data.frame(as.character(norm_tots_df$Var1), as.numeric(norm_tots_df$Freq))
colnames(norm_tots_df) <-c("ID","norm_tot")
least_active <- norm_tots_df$ID[norm_tots_df$norm_tot == min(norm_tots_df$norm_tot)]

print(paste("Least active bird: ",least_active))
```

# Most Active Bird

```{r most active bird analysis all rooms}
set.seed(34716)
library(scales)
library(stringr)
library(ggplot2)
library(lubridate)

daily <- data.frame()
weekly <- data.frame()
monthly <- data.frame()
#TODO select sample as opposed to ID for intra bird comparison (alpha eq)
for(item in trans_reslist_room_2){
  daily <- rbind(daily, item$daily[c("sample","ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("sample","ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("sample","ID","bottom","mid","top","total")])
}
for(item in trans_reslist_room_3){
  daily <- rbind(daily, item$daily[c("sample","ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("sample","ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("sample","ID","bottom","mid","top","total")])
}
for(item in trans_reslist_room_8){
  daily <- rbind(daily, item$daily[c("sample","ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("sample","ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("sample","ID","bottom","mid","top","total")])
}
for(item in trans_reslist_room_11){
  daily <- rbind(daily, item$daily[c("sample","ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("sample","ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("sample","ID","bottom","mid","top","total")])
}

for(j in 1:length(most_active)){
most_active_intra_day <- daily[grep(most_active[j], daily$ID),]
most_active_intra_day <- as.data.frame(most_active_intra_day)
most_active_intra_day[,3:6] <- sapply(most_active_intra_day[,3:6], as.numeric)
boxplot(most_active_intra_day[,3:6])
hist(most_active_intra_day[,6])
}

wss <- 0

for(i in 1:15){
  km.out <- kmeans(most_active_intra_day[,3:5], centers = i, nstart=20)
  wss[i] <- km.out$tot.withinss
}


plot(1:15, wss, type="b")

km.out <- kmeans(most_active_intra_day[,3:5],3, 20)
#km.out <- kmeans(most_active_intra_day[,2:4],3, 20)
summary(km.out)
table(km.out$cluster)

pr.feb <- prcomp(x=most_active_intra_day[,3:5], scale=T, center=T)
pr.feb.prop <- summary(pr.feb)
most_active_intra_day["day"] <- as.character(str_split_fixed(most_active_intra_day$sample, ".",6)[,6])
most_active_intra_day["week"]<- (week(most_active_intra_day$day)+23)
most_active_intra_day["cluster"] <- km.out$cluster
most_active_intra_day
pr.feb$x <- data.frame(pr.feb$x)

p <- ggplot(pr.feb$x[,1:2], aes(x=PC1, y=PC2, color=as.character(most_active_intra_day$cluster)))+
  geom_point() +
  labs(title=paste("Most Active Bird (",most_active,")"),x=paste("PC1 (",round(pr.feb.prop$importance[[2,1]]*100,2),"%)"),y=paste("PC2 (",round(pr.feb.prop$importance[[2,2]]*100,2),"%)"),color="Cluster") +
  scale_color_discrete(name = "Weeks", labels= c(as.character(paste(most_active_intra_day$week[most_active_intra_day$cluster == 1],collapse=",")),as.character(paste(most_active_intra_day$week[most_active_intra_day$cluster == 2],collapse=",")),as.character(paste(most_active_intra_day$week[most_active_intra_day$cluster == 3],collapse=",")))) +
  theme_bw() + 
  theme(legend.position = "bottom", legend.direction = "vertical",legend.text = element_text(size=8))
p
ggsave(p, filename = paste0("../figures/",as.character(most_active[j]),"_most_active_bird_pca_all_rooms.png"),device = "png",width = unit(7,"in"),height=unit(7,"in"))


cluster_table <- data.frame(cbind(as.numeric(km.out$cluster),most_active_intra_day$sample))
cluster_table[order(cluster_table$X1),]

most_active_intra_day[order(most_active_intra_day$total),]



most_active_grp <- data.frame(x = as.Date(most_active_intra_day$day), y = c(most_active_intra_day$bottom, most_active_intra_day$mid, most_active_intra_day$top), group= c(rep("Bottom",nrow(most_active_intra_day)),rep("Mid",nrow(most_active_intra_day)),rep("Top",nrow(most_active_intra_day))))



 q <- ggplot(most_active_grp, aes(x,y,col=group))+
  geom_line() +
  facet_grid(factor(group,levels=c("Top","Mid","Bottom"))~ .) +
  labs(title=paste("Most Active Bird (",most_active[j],") Transitions"), color="Legend")+
  scale_x_date(name="Weeks",breaks = seq(min(most_active_grp$x),max(most_active_grp$x),by="week"),labels = as.numeric(format(seq(min(most_active_grp$x),max(most_active_grp$x),by="week"),"%U"))+23)+
  scale_y_continuous(name="Transitions Into",n.breaks = 8,limits = c(0,65)) +
  scale_color_manual(values=c("Top"="royalblue","Mid"="tomato","Bottom" = "seagreen")) +
  theme_bw()
  
q

ggsave(q, filename = paste0("../figures/",as.character(most_active[j]),"_most_active_transitions_per_day_all_rooms.png"),device="png")

```

# Least Active Bird

```{r least active bird time all rooms}
library(stringr)
library(ggplot2)

daily <- data.frame()
weekly <- data.frame()
monthly <- data.frame()
#TODO select sample as opposed to ID for intra bird comparison (alpha eq)
for(item in trans_reslist_room_2){
  daily <- rbind(daily, item$daily[c("sample","ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("sample","ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("sample","ID","bottom","mid","top","total")])
}
for(item in trans_reslist_room_3){
  daily <- rbind(daily, item$daily[c("sample","ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("sample","ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("sample","ID","bottom","mid","top","total")])
}
for(item in trans_reslist_room_8){
  daily <- rbind(daily, item$daily[c("sample","ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("sample","ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("sample","ID","bottom","mid","top","total")])
}
for(item in trans_reslist_room_11){
  daily <- rbind(daily, item$daily[c("sample","ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("sample","ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("sample","ID","bottom","mid","top","total")])
}

least_active_intra_day <- daily[grep(least_active,daily$ID),]
least_active_intra_day <- as.data.frame(least_active_intra_day)
least_active_intra_day[,3:6] <- sapply(least_active_intra_day[,3:6], as.numeric)
boxplot(least_active_intra_day[,3:6])
hist(least_active_intra_day[,5])

wss <- 0

for(i in 1:10){
  km.out <- kmeans(least_active_intra_day[,3:5], centers = i, nstart=20)
  wss[i] <- km.out$tot.withinss
}


plot(1:10, wss, type="b")

km.out <- kmeans(least_active_intra_day[,3:5],3, 20)
summary(km.out)
table(km.out$cluster)

pr.feb <- prcomp(x=least_active_intra_day[,3:5], scale=T, center=F)
pr.feb.prop <- summary(pr.feb)

pr.feb.prop$importance
pr.feb$x <- data.frame(pr.feb$x)


least_active_intra_day["day"] <- as.character(str_split_fixed(least_active_intra_day$sample, ".",6)[,6])
least_active_intra_day["week"]<- (week(least_active_intra_day$day)+23)
least_active_intra_day["cluster"] <- km.out$cluster
least_active_intra_day

p <- ggplot(pr.feb$x[,1:2], aes(x=PC1, y=PC2, color=as.character(least_active_intra_day$cluster)))+
  geom_point() + 
  labs(title=paste("Least Active Bird (",least_active,")"),x=paste("PC1 (",round(pr.feb.prop$importance[[2,1]]*100,2),"%)"),y=paste("PC2 (",round(pr.feb.prop$importance[[2,2]]*100,2),"%)"),color="Cluster") +
  scale_color_discrete(name = "Weeks", labels= c(as.character(paste(least_active_intra_day$week[least_active_intra_day$cluster == 1],collapse=",")),as.character(paste(least_active_intra_day$week[least_active_intra_day$cluster == 2],collapse=",")),as.character(paste(least_active_intra_day$week[least_active_intra_day$cluster == 3],collapse=",")))) +
  theme_bw() + 
  theme(legend.position = "bottom", legend.direction = "vertical",legend.text = element_text(size=8))
p
ggsave(p, filename = "../figures/least_active_bird_pca_all_rooms.png",device = "png",width = unit(7.5,"in"),height=unit(7.5,"in"))

cluster_table <- data.frame(cbind(as.numeric(km.out$cluster),least_active_intra_day$sample))
cluster_table[order(cluster_table$X1),]

least_active_intra_day[order(least_active_intra_day$total),]
least_active_intra_day


least_active_grp <- data.frame(x = as.Date(least_active_intra_day$day), y = c(least_active_intra_day$bottom, least_active_intra_day$mid, least_active_intra_day$top), group= c(rep("Bottom",nrow(least_active_intra_day)),rep("Mid",nrow(least_active_intra_day)),rep("Top",nrow(least_active_intra_day))))



q <-ggplot(least_active_grp, aes(x,y,col=group))+
  geom_line() +
  facet_grid(factor(group,levels=c("Top","Mid","Bottom"))~ .) +
  labs(title=paste("Least Active Bird (",least_active,") Transitions"), color="Legend")+
  scale_x_date(name="Weeks",breaks = seq(min(least_active_grp$x),max(least_active_grp$x),by="week"),labels = as.numeric(format(seq(min(least_active_grp$x),max(least_active_grp$x),by="week"),"%U"))+23)+
  scale_y_continuous(name="Transitions Into",n.breaks = 8,limits = c(0,65)) +
  scale_color_manual(values=c("Top"="royalblue","Mid"="tomato","Bottom" = "seagreen")) +
  theme_bw()
q
ggsave(q, filename="../figures/least_active_transitions_per_day_all_rooms.png",device="png")
```

# Organize Birds By activity 

```{r evaluate transition cloumn sum on the daily data all rooms}
library(qpcR)

trans_reslists <- c(trans_reslist_room_2,trans_reslist_room_3,trans_reslist_room_8,trans_reslist_room_11)
#trans_reslists <- c(trans_reslist_room_2,trans_reslist_room_8,trans_reslist_room_11)
daily_colsum <- data.frame()

#each item is one transition list for an intra bird sample
#we want to sum up the columns for each day and compare bird to bird


for(i in 1:length(trans_reslists)){
  res <- colSums(sapply(trans_reslists[[i]]$daily[,2:6], as.numeric))
  res[1] <- res[1]/length(trans_reslists[[i]]$daily$ID)
  res[6] <- round(res[2]/length(trans_reslists[[i]]$daily$bottom),0)
  res[7] <- round(res[3]/length(trans_reslists[[i]]$daily$mid),0)
  res[8] <- round(res[4]/length(trans_reslists[[i]]$daily$top),0)
  res[9] <- round(res[5]/length(trans_reslists[[i]]$daily$total),0)
  daily_colsum <- rbind(daily_colsum,res)
}

colnames(daily_colsum) <- c("ID","bottom","mid","top","total","bottom_A","mid_A","top_a","total_A")
daily_colsum
hold <- daily_colsum[order(daily_colsum$total_A,decreasing = T),]

summary(hold[,6:9])
boxplot(hold[,6:9])

low_act <- c()
med_act <- c()
high_act <- c()

#TODO Check these values
for(i in 1:length(hold[,1])){
  cur_tol <- hold[i,9]
  if(cur_tol<=14){
    low_act <- c(low_act,hold[i,1])
  }
  if((cur_tol>14) & (cur_tol<=45)){
    med_act <- c(med_act,hold[i,1])
  }
  if(cur_tol>45){
    high_act <- c(high_act, hold[i,1])
  }
}


cluster_table <- data.frame(qpcR:::cbind.na(low_act,med_act,high_act))
cluster_table
write.csv(cluster_table, "../output/organized_birds_by_activity_daily_all_rooms.csv",row.names = F)
```

```{r make a better csv table for all rooms}

# find which room each ID is in:
updated_table <- data.frame()

all_selected_ids <- c(low_act,med_act,high_act)
new_row <- ""
activity <- ""
room <- ""

for(id in all_selected_ids){
  #find out which activity level id is in 
  if(id %in% low_act){
      activity <- "low"
  } else if( id %in% med_act){
      activity <- "medium"
  } else { 
      activity <- "high"
  }
  #find out which room id is in 
  if(id %in% bird_ids_room_2){
      room <- "2"
  } else if(id %in% bird_ids_room_3 ){
      room <- "3"
  } else if( id %in% bird_ids_room_8 ){
      room <- "8"
  } else if( id %in% bird_ids_room_11 ) { 
      room <- "11"
  }
  #add row to updated table
  new_row <- c(room, id, activity)
  updated_table <- rbind(updated_table, new_row)
}

colnames(updated_table) <- c("Room", "Bird ID", "Activity Level")
write.csv(updated_table, "../output/organized_birds_by_activity_daily_all_rooms_nice_table.csv",row.names = F)
```

## Jumpy table for the separated samples

```{r make a jumpy table for the low activity birds all rooms}
# Aggregate the low activity birds
low_act_bird_ids <- na.trim(cluster_table$low_act)

#make a table of the samples
low_act_bird_frame <- data.frame()

for(id in low_act_bird_ids){
  curr_bird <- daily[grep(id,daily$sample),]
  low_act_bird_frame <- rbind(low_act_bird_frame,curr_bird)
}

low_act_bird_frame[,3:6] <- sapply(low_act_bird_frame[,3:6], as.numeric)
low_act_bird_frame["day"] <- as.character(str_split_fixed(low_act_bird_frame$sample, ".",6)[,6])
low_act_agg_tab <- aggregate(low_act_bird_frame[,3:6],by = list(low_act_bird_frame$day), FUN = mean)
colnames(low_act_agg_tab) <- c("day","bottom","mid","top","total")

# Aggregate the medium activity birds
med_act_bird_ids <- na.trim(cluster_table$med_act)

#make a table of the samples
med_act_bird_frame <- data.frame()

for(id in med_act_bird_ids){
  curr_bird <- daily[grep(id,daily$sample),]
  med_act_bird_frame <- rbind(med_act_bird_frame,curr_bird)
}

med_act_bird_frame[,3:6] <- sapply(med_act_bird_frame[,3:6], as.numeric)
med_act_bird_frame["day"] <- as.character(str_split_fixed(med_act_bird_frame$sample, ".",6)[,6])
med_act_agg_tab <- aggregate(med_act_bird_frame[,3:6],by = list(med_act_bird_frame$day), FUN = mean)
colnames(med_act_agg_tab) <- c("day","bottom","mid","top","total")

# Aggregate the high activity birds
high_act_bird_ids <- na.trim(cluster_table$high_act)

#make a table of the samples
high_act_bird_frame <- data.frame()

for(id in high_act_bird_ids){
  curr_bird <- daily[grep(id,daily$sample),]
  high_act_bird_frame <- rbind(high_act_bird_frame,curr_bird)
}

high_act_bird_frame[,3:6] <- sapply(high_act_bird_frame[,3:6], as.numeric)
high_act_bird_frame["day"] <- as.character(str_split_fixed(high_act_bird_frame$sample, ".",6)[,6])
high_act_agg_tab <- aggregate(high_act_bird_frame[,3:6],by = list(high_act_bird_frame$day), FUN = mean)
colnames(high_act_agg_tab) <- c("day","bottom","mid","top","total")

# plot the low activity birds
low_act_grp <- data.frame(x = as.Date(low_act_agg_tab$day), y = c(low_act_agg_tab$bottom, low_act_agg_tab$mid, low_act_agg_tab$top), group= c(rep("Bottom",nrow(low_act_agg_tab)),rep("Mid",nrow(low_act_agg_tab)),rep("Top",nrow(low_act_agg_tab))), activity=c(rep('Low',nrow(low_act_agg_tab)*3)))

med_act_grp <- data.frame(x = as.Date(med_act_agg_tab$day), y = c(med_act_agg_tab$bottom, med_act_agg_tab$mid, med_act_agg_tab$top), group= c(rep("Bottom",nrow(med_act_agg_tab)),rep("Mid",nrow(med_act_agg_tab)),rep("Top",nrow(med_act_agg_tab))), activity=c(rep('Medium',nrow(low_act_agg_tab)*3)))

# plot the low activity birds
high_act_grp <- data.frame(x = as.Date(high_act_agg_tab$day), y = c(high_act_agg_tab$bottom, high_act_agg_tab$mid, high_act_agg_tab$top), group= c(rep("Bottom",nrow(high_act_agg_tab)),rep("Mid",nrow(high_act_agg_tab)),rep("Top",nrow(high_act_agg_tab))), activity=c(rep('High',nrow(low_act_agg_tab)*3)))

combo_table <- rbind(low_act_grp, med_act_grp, high_act_grp)

q <-ggplot(combo_table, aes(x,y,col=activity))+
  geom_line(aes(col=activity)) +
  facet_grid(factor(group,levels=c("Top","Mid","Bottom"))~ ., scales = "free_y") +
  labs(title=paste0("Activity Birds Transitions (n=",length(unique(daily$ID)),")"), color="Activity Level")+
  scale_x_date(name="Weeks",breaks = seq(min(combo_table$x),max(combo_table$x),by="week"),labels = as.numeric(format(seq(min(combo_table$x),max(combo_table$x),by="week"),"%U"))+23)+
  scale_y_continuous(name="Average Transitions Into",n.breaks = 8) +
  scale_color_manual(values=c("Low"="royalblue","Medium"="tomato","High" = "seagreen")) +
  theme_bw()
  ggsave(q, filename="../figures/active_transitions_all_rooms_set_2.png",device="png")
```

# Zone Occupying Table for all rooms

```{r make a zone occupation table with all rooms}
library(dplyr)

all_room_zone_table <- data.frame()
result <- ""

for(item in trans_reslist_room_2){
  result <- calc_zone_duration("room 2", item$ID, item$raw)
  all_room_zone_table <- rbind(all_room_zone_table, result)
}
for(item in trans_reslist_room_3){
  result <- calc_zone_duration("room 3", item$ID, item$raw)
  all_room_zone_table <- rbind(all_room_zone_table, result)
}
for(item in trans_reslist_room_8){
  result <- calc_zone_duration("room 8", item$ID, item$raw)
  all_room_zone_table <- rbind(all_room_zone_table, result)
}
for(item in trans_reslist_room_11){
  result <- calc_zone_duration("room 11", item$ID, item$raw)
  all_room_zone_table <- rbind(all_room_zone_table, result)
}

# change the resultant times to numerics as opposed to chars
all_room_zone_table[,3:5] <- sapply(all_room_zone_table[,3:5],function(x) as.numeric(as.character(x)))
all_room_zone_table[,3:5] <- (all_room_zone_table[,3:5])/60
# calculate the number of days observed
all_room_zone_table["days_observed"]<- round((rowSums(all_room_zone_table[,3:5])/60)/24)
colnames(all_room_zone_table) <-  c("Room","ID", "Time in Bottom","Time in Middle", "Time in Top","Days Observed")


write.csv(all_room_zone_table, "../output/zone_time_per_id_all_rooms.csv", row.names=F)

ave_time_per_room <- aggregate(cbind(all_room_zone_table$"Time in Bottom",all_room_zone_table$"Time in Middle",all_room_zone_table$"Time in Top"),list(all_room_zone_table$Room),mean)

colnames(ave_time_per_room) <- c("Room", "Average Time in Bottom", "Average Time in Middle", "Average Time in Top")

write.csv(ave_time_per_room, "../output/zone_time_per_room_all_rooms.csv", row.names=F)


```


# Intra-Bird Analysis For Longer Series

```{r re-generate reslists2 for each room}

remove <- c("6910","6966","6914")
bird_ids_room_2_new <- bird_ids_room_2 [! bird_ids_room_2  %in% remove ]
#generate list of the first 10 truncated XTS objects
reslist2_room_2 <- list()
for(i in 1:length(bird_ids_room_2_new)){
  res <- sep_bird_id_period(samp_name="room 2",cage_obj =room_2, samp_id = bird_ids_room_2_new[i],cutoff = "2021-02-18 T23:30:00/2021-05-06 T23:00:00")
  reslist2_room_2[[i]] <- res
}

remove <-c("6949","6936","6974","9009","9011","6995")
bird_ids_room_8_new <- bird_ids_room_8 [! bird_ids_room_8  %in% remove ]
#generate list of the first 10 truncated XTS objects
reslist2_room_8 <- list()
for(i in 1:length(bird_ids_room_8_new)){
  res <- sep_bird_id_period(samp_name="room 8",cage_obj =room_8, samp_id = bird_ids_room_8_new[i],cutoff = "2021-02-18 T23:30:00/2021-05-06 T23:00:00")
  reslist2_room_8[[i]] <- res
}

remove <- c("6888","6868","6880","6881","6893","6892", "6894","6862","6898","6882","6899","6887","6896","6889","6895","6885","6900","6897","6891","6884","6906","6920","6954","6991","6930","9059","9060")
bird_ids_room_11_new <- bird_ids_room_11 [! bird_ids_room_11  %in% remove ]
#generate list of the first 10 truncated XTS objects
reslist2_room_11 <- list()
for(i in 1:length(bird_ids_room_11_new)){
  res <- sep_bird_id_period(samp_name="room 11",cage_obj =room_11, samp_id = bird_ids_room_11_new[i], cutoff="2021-02-18 T23:30:00/2021-05-06 T23:00:00")
  reslist2_room_11[[i]] <- res
}


```

```{r }
trans_reslist_room_2 <- list()

for(i in 1:length(reslist2_room_2)){
  
  daily_trans_table <- calc_trans_period(reslist2_room_2[[i]]$ID,reslist2_room_2[[i]]$daily_obj,reslist2_room_2[[i]]$xts_obj,"d", 0)
  weekly_trans_table <- calc_trans_period(reslist2_room_2[[i]]$ID,reslist2_room_2[[i]]$weekly_obj,reslist2_room_2[[i]]$xts_obj,"w", 0)
  monthly_trans_table <- calc_trans_period(reslist2_room_2[[i]]$ID,reslist2_room_2[[i]]$monthly_obj,reslist2_room_2[[i]]$xts_obj,"m",0)
    
  result <- list("ID"=reslist2_room_2[[i]]$ID,"daily"=daily_trans_table, "weekly"=weekly_trans_table,"monthly"=monthly_trans_table, "raw"=reslist2_room_2[[i]]$xts_obj)
  trans_reslist_room_2[[i]] <- result
}

room_2_daily <- data.frame()
room_2_weekly <- data.frame()
room_2_monthly <- data.frame()
#TODO select sample as opposed to ID for intra bird comparison (alpha eq)
for(item in trans_reslist_room_2){
  room_2_daily <- rbind(room_2_daily, item$daily[c("sample","bottom","mid","top","total")])
  room_2_weekly <- rbind(room_2_weekly, item$weekly[c("sample","bottom","mid","top","total")])
  room_2_monthly <- rbind(room_2_monthly, item$monthly[c("sample","bottom","mid","top","total")])
}

# check to make sure only one bird is selected
print("check that the id and RFID tag are unique for each item entry")
#this is following up with the issues of the intra-bird comparisons
for(item in trans_reslist_room_2){
  print(paste(unique(item$raw$tagnumber)," ",unique(item$raw$tagname)))
  #print(item)
}

trans_reslist_room_8 <- list()

for(i in 1:length(reslist2_room_8)){
  
  daily_trans_table <- calc_trans_period(reslist2_room_8[[i]]$ID,reslist2_room_8[[i]]$daily_obj,reslist2_room_8[[i]]$xts_obj,"d",0)
  weekly_trans_table <- calc_trans_period(reslist2_room_8[[i]]$ID,reslist2_room_8[[i]]$weekly_obj,reslist2_room_8[[i]]$xts_obj,"w",0)
  monthly_trans_table <- calc_trans_period(reslist2_room_8[[i]]$ID,reslist2_room_8[[i]]$monthly_obj,reslist2_room_8[[i]]$xts_obj,"m",0)
    
  result <- list("ID"=reslist2_room_8[[i]]$ID,"daily"=daily_trans_table, "weekly"=weekly_trans_table,"monthly"=monthly_trans_table, "raw"=reslist2_room_8[[i]]$xts_obj)
  trans_reslist_room_8[[i]] <- result
}

room_8_daily <- data.frame()
room_8_weekly <- data.frame()
room_8_monthly <- data.frame()
#TODO select sample as opposed to ID for intra bird comparison (alpha eq)
for(item in trans_reslist_room_8){
  room_8_daily <- rbind(room_8_daily, item$daily[c("sample","bottom","mid","top","total")])
  room_8_weekly <- rbind(room_8_weekly, item$weekly[c("sample","bottom","mid","top","total")])
  room_8_monthly <- rbind(room_8_monthly, item$monthly[c("sample","bottom","mid","top","total")])
}

# check to make sure only one bird is selected
print("check that the id and RFID tag are unique for each item entry")
#this is following up with the issues of the intra-bird comparisons
for(item in trans_reslist_room_8){
  print(paste(unique(item$raw$tagnumber)," ",unique(item$raw$tagname)))
  #print(item)
}

trans_reslist_room_11 <- list()

for(i in 1:length(reslist2_room_11)){
  
  daily_trans_table <- calc_trans_period(reslist2_room_11[[i]]$ID,reslist2_room_11[[i]]$daily_obj,reslist2_room_11[[i]]$xts_obj,"d")
  weekly_trans_table <- calc_trans_period(reslist2_room_11[[i]]$ID,reslist2_room_11[[i]]$weekly_obj,reslist2_room_11[[i]]$xts_obj,"w")
  monthly_trans_table <- calc_trans_period(reslist2_room_11[[i]]$ID,reslist2_room_11[[i]]$monthly_obj,reslist2_room_11[[i]]$xts_obj,"m")
    
  result <- list("ID"=reslist2_room_11[[i]]$ID,"daily"=daily_trans_table, "weekly"=weekly_trans_table,"monthly"=monthly_trans_table, "raw"=reslist2_room_11[[i]]$xts_obj)
  trans_reslist_room_11[[i]] <- result
}

room_11_daily <- data.frame()
room_11_weekly <- data.frame()
room_11_monthly <- data.frame()
#TODO select sample as opposed to ID for intra bird comparison (alpha eq)
for(item in trans_reslist_room_11){
  room_11_daily <- rbind(room_11_daily, item$daily[c("sample","bottom","mid","top","total")])
  room_11_weekly <- rbind(room_11_weekly, item$weekly[c("sample","bottom","mid","top","total")])
  room_11_monthly <- rbind(room_11_monthly, item$monthly[c("sample","bottom","mid","top","total")])
}

# check to make sure only one bird is selected
print("check that the id and RFID tag are unique for each item entry")
#this is following up with the issues of the intra-bird comparisons
for(item in trans_reslist_room_11){
  print(paste(unique(item$raw$tagnumber)," ",unique(item$raw$tagname)))
  #print(item)
}


#write.csv(room_2_daily,"room_2_daily_intra.csv",row.names = F)
#write.csv(room_2_weekly,"room_2_weekly_intra.csv",row.names = F)
#write.csv(room_2_monthly,"room_2_monthly_intra.csv",row.names = F)

```


## Determine which bird is the most active in the Whole Dataset without room 3

```{r who is the most active without room 3?}
daily <- data.frame()
weekly <- data.frame()
monthly <- data.frame()
#TODO select sample as opposed to ID for intra bird comparison (alpha eq)
for(item in trans_reslist_room_2){
  daily <- rbind(daily, item$daily[c("ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("ID","bottom","mid","top","total")])
}

for(item in trans_reslist_room_8){
  daily <- rbind(daily, item$daily[c("ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("ID","bottom","mid","top","total")])
}
for(item in trans_reslist_room_11){
  daily <- rbind(daily, item$daily[c("ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("ID","bottom","mid","top","total")])
}
length(unique(daily$ID))
unique(daily$ID)

tmp <- cbind(as.character(daily$ID), as.numeric(daily$total))
tmp_df <- data.frame(as.numeric(tmp[,1]), as.numeric(tmp[,2]))
colnames(tmp_df) <- c("ID","total")
transitions <- aggregate(total ~ ID, data=tmp_df, FUN=sum)
days <- table(tmp_df$ID)
norm_tots <- round(transitions$total/days,0)
norm_tots_df <- data.frame(norm_tots)
norm_tots_df <- data.frame(as.character(norm_tots_df$Var1), as.numeric(norm_tots_df$Freq))
colnames(norm_tots_df) <-c("ID","norm_tot")
most_active <- norm_tots_df$ID[norm_tots_df$norm_tot == max(norm_tots_df$norm_tot)]

print(paste("Most active bird: ",most_active))
```

## Determine which bird is the least active in the Room 2 Dataset

```{r who is the least active without room 3?}
daily <- data.frame()
weekly <- data.frame()
monthly <- data.frame()
#TODO select sample as opposed to ID for intra bird comparison (alpha eq)
for(item in trans_reslist_room_2){
  daily <- rbind(daily, item$daily[c("ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("ID","bottom","mid","top","total")])
}

for(item in trans_reslist_room_8){
  daily <- rbind(daily, item$daily[c("ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("ID","bottom","mid","top","total")])
}
for(item in trans_reslist_room_11){
  daily <- rbind(daily, item$daily[c("ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("ID","bottom","mid","top","total")])
}
tmp <- cbind(as.character(daily$ID), as.numeric(daily$total))
tmp_df <- data.frame(as.numeric(tmp[,1]), as.numeric(tmp[,2]))
colnames(tmp_df) <- c("ID","total")
transitions <- aggregate(total ~ ID, data=tmp_df, FUN=sum)
days <- table(tmp_df$ID)
norm_tots <- round(transitions$total/days,0)
norm_tots_df <- data.frame(norm_tots)
norm_tots_df <- data.frame(as.character(norm_tots_df$Var1), as.numeric(norm_tots_df$Freq))
colnames(norm_tots_df) <-c("ID","norm_tot")
least_active <- norm_tots_df$ID[norm_tots_df$norm_tot == min(norm_tots_df$norm_tot)]

print(paste("Least active bird: ",least_active))
```

# Most Active Bird

```{r most active bird analysis no room 3}
set.seed(34716)
library(scales)
library(stringr)
library(ggplot2)
library(lubridate)

daily <- data.frame()
weekly <- data.frame()
monthly <- data.frame()
#TODO select sample as opposed to ID for intra bird comparison (alpha eq)
for(item in trans_reslist_room_2){
  daily <- rbind(daily, item$daily[c("sample","ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("sample","ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("sample","ID","bottom","mid","top","total")])
}

for(item in trans_reslist_room_8){
  daily <- rbind(daily, item$daily[c("sample","ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("sample","ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("sample","ID","bottom","mid","top","total")])
}
for(item in trans_reslist_room_11){
  daily <- rbind(daily, item$daily[c("sample","ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("sample","ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("sample","ID","bottom","mid","top","total")])
}

for(j in 1:length(most_active)){
most_active_intra_day <- daily[grep(most_active[j], daily$ID),]
most_active_intra_day <- as.data.frame(most_active_intra_day)
most_active_intra_day[,3:6] <- sapply(most_active_intra_day[,3:6], as.numeric)
boxplot(most_active_intra_day[,3:6])
hist(most_active_intra_day[,6])

wss <- 0

for(i in 1:15){
  km.out <- kmeans(most_active_intra_day[,3:5], centers = i, nstart=20)
  wss[i] <- km.out$tot.withinss
}


plot(1:15, wss, type="b")

km.out <- kmeans(most_active_intra_day[,3:5],3, 20)
#km.out <- kmeans(most_active_intra_day[,2:4],3, 20)
summary(km.out)
table(km.out$cluster)

pr.feb <- prcomp(x=most_active_intra_day[,3:5], scale=T, center=T)
pr.feb.prop <- summary(pr.feb)
most_active_intra_day["day"] <- as.character(str_split_fixed(most_active_intra_day$sample, ".",6)[,6])
most_active_intra_day["week"]<- (week(most_active_intra_day$day)+23)
most_active_intra_day["cluster"] <- km.out$cluster
most_active_intra_day
pr.feb$x <- data.frame(pr.feb$x)

p <- ggplot(pr.feb$x[,1:2], aes(x=PC1, y=PC2, color=as.character(most_active_intra_day$cluster)))+
  geom_point() +
  labs(title=paste("Most Active Bird (",most_active,")"),x=paste("PC1 (",round(pr.feb.prop$importance[[2,1]]*100,2),"%)"),y=paste("PC2 (",round(pr.feb.prop$importance[[2,2]]*100,2),"%)"),color="Cluster") +
  scale_color_discrete(name = "Weeks", labels= c(as.character(paste(most_active_intra_day$week[most_active_intra_day$cluster == 1],collapse=",")),as.character(paste(most_active_intra_day$week[most_active_intra_day$cluster == 2],collapse=",")),as.character(paste(most_active_intra_day$week[most_active_intra_day$cluster == 3],collapse=",")))) +
  theme_bw() + 
  theme(legend.position = "bottom", legend.direction = "vertical",legend.text = element_text(size=8))
p
ggsave(p, filename = paste0("../figures/",as.character(most_active[j]),"_most_active_bird_pca_no_rm_3.png"),device = "png",width = unit(7,"in"),height=unit(7,"in"))


cluster_table <- data.frame(cbind(as.numeric(km.out$cluster),most_active_intra_day$sample))
cluster_table[order(cluster_table$X1),]

most_active_intra_day[order(most_active_intra_day$total),]



most_active_grp <- data.frame(x = as.Date(most_active_intra_day$day), y = c(most_active_intra_day$bottom, most_active_intra_day$mid, most_active_intra_day$top), group= c(rep("Bottom",nrow(most_active_intra_day)),rep("Mid",nrow(most_active_intra_day)),rep("Top",nrow(most_active_intra_day))))



 q <- ggplot(most_active_grp, aes(x,y,col=group))+
  geom_line() +
  facet_grid(factor(group,levels=c("Top","Mid","Bottom"))~ .) +
  labs(title=paste("Most Active Bird (",most_active[j],") Transitions"), color="Legend")+
  scale_x_date(name="Weeks",breaks = seq(min(most_active_grp$x),max(most_active_grp$x),by="week"),labels = as.numeric(format(seq(min(most_active_grp$x),max(most_active_grp$x),by="week"),"%U"))+23)+
  scale_y_continuous(name="Transitions Into",n.breaks = 8,limits = c(0,70)) +
  scale_color_manual(values=c("Top"="royalblue","Mid"="tomato","Bottom" = "seagreen")) +
  theme_bw()
  
q

ggsave(q, filename = paste0("../figures/",as.character(most_active[j]),"_most_active_transitions_per_day_no_rm_3.png"),device="png")
}
```

# Least Active Bird

```{r least active bird time no room 3}
library(stringr)
library(ggplot2)

daily <- data.frame()
weekly <- data.frame()
monthly <- data.frame()
#TODO select sample as opposed to ID for intra bird comparison (alpha eq)
for(item in trans_reslist_room_2){
  daily <- rbind(daily, item$daily[c("sample","ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("sample","ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("sample","ID","bottom","mid","top","total")])
}

for(item in trans_reslist_room_8){
  daily <- rbind(daily, item$daily[c("sample","ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("sample","ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("sample","ID","bottom","mid","top","total")])
}
for(item in trans_reslist_room_11){
  daily <- rbind(daily, item$daily[c("sample","ID","bottom","mid","top","total")])
  weekly <- rbind(weekly, item$weekly[c("sample","ID","bottom","mid","top","total")])
  monthly <- rbind(monthly, item$monthly[c("sample","ID","bottom","mid","top","total")])
}

for (j in 1:length(least_active))
{
  least_active_intra_day <- daily[grep(least_active[j],daily$ID),]
  least_active_intra_day <- as.data.frame(least_active_intra_day)
  least_active_intra_day[,3:6] <- sapply(least_active_intra_day[,3:6], as.numeric)
  boxplot(least_active_intra_day[,3:6])
  hist(least_active_intra_day[,5])

  wss <- 0

  for(i in 1:15){
    km.out <- kmeans(least_active_intra_day[,3:5], centers = i, nstart=20)
    wss[i] <- km.out$tot.withinss
  }


  plot(1:15, wss, type="b")

  km.out <- kmeans(least_active_intra_day[,3:5],3, 20)
  summary(km.out)
  table(km.out$cluster)

  pr.feb <- prcomp(x=least_active_intra_day[,3:5], scale=T, center=F)
  pr.feb.prop <- summary(pr.feb)

  pr.feb.prop$importance
  pr.feb$x <- data.frame(pr.feb$x)


  least_active_intra_day["day"] <- as.character(str_split_fixed(least_active_intra_day$sample, ".",6)[,6])
  least_active_intra_day["week"]<- (week(least_active_intra_day$day)+23)
  least_active_intra_day["cluster"] <- km.out$cluster
  least_active_intra_day

  p <- ggplot(pr.feb$x[,1:2], aes(x=PC1, y=PC2, color=as.character(least_active_intra_day$cluster)))+
    geom_point() + 
    labs(title=paste("Least Active Bird (",least_active[j],")"),x=paste("PC1 (",round(pr.feb.prop$importance[[2,1]]*100,2),"%)"),y=paste("PC2 (",round(pr.feb.prop$importance[[2,2]]*100,2),"%)"),color="Cluster") +
    scale_color_discrete(name = "Weeks", labels= c(as.character(paste(least_active_intra_day$week[least_active_intra_day$cluster == 1],collapse=",")),as.character(paste(least_active_intra_day$week[least_active_intra_day$cluster == 2],collapse=",")),as.character(paste(least_active_intra_day$week[least_active_intra_day$cluster == 3],collapse=",")))) +
    theme_bw() + 
    theme(legend.position = "bottom", legend.direction = "vertical",legend.text = element_text(size=8))
  p
                  
  ggsave(p, filename = paste0("../figures/",as.character(least_active[j]),"_least_active_bird_pca.png"),device = "png",width = unit(7.5,"in"),height=unit(7.5,"in"))

  cluster_table <- data.frame(cbind(as.numeric(km.out$cluster),least_active_intra_day$sample))
  cluster_table[order(cluster_table$X1),]

  least_active_intra_day[order(least_active_intra_day$total),]
  least_active_intra_day


  least_active_grp <- data.frame(x = as.Date(least_active_intra_day$day), y = c(least_active_intra_day$bottom, least_active_intra_day$mid, least_active_intra_day$top), group= c(rep("Bottom",nrow(least_active_intra_day)),rep("Mid",nrow(least_active_intra_day)),rep("Top",nrow(least_active_intra_day))))



  q <-ggplot(least_active_grp, aes(x,y,col=group))+
    geom_line() +
    facet_grid(factor(group,levels=c("Top","Mid","Bottom"))~ .) +
    labs(title=paste("Least Active Bird (",least_active[j],") Transitions"), color="Legend")+
    scale_x_date(name="Weeks",breaks = seq(min(least_active_grp$x),max(least_active_grp$x),by="week"),labels = as.numeric(format(seq(min(least_active_grp$x),max(least_active_grp$x),by="week"),"%U"))+23)+
    scale_y_continuous(name="Transitions Into",n.breaks = 8,limits = c(0,70)) +
    scale_color_manual(values=c("Top"="royalblue","Mid"="tomato","Bottom" = "seagreen")) +
    theme_bw()
  q
  ggsave(q, filename=paste0("../figures/",as.character(least_active[j]),"_least_active_transitions_per_day.png"),device="png")
}

```

# Organize Birds By activity 

```{r evaluate transition cloumn sum on the daily data no room 3}
library(qpcR)

#trans_reslists <- c(trans_reslist_room_2,trans_reslist_room_3,trans_reslist_room_8,trans_reslist_room_11)
trans_reslists <- c(trans_reslist_room_2,trans_reslist_room_8,trans_reslist_room_11)
daily_colsum <- data.frame()

#each item is one transition list for an intra bird sample
#we want to sum up the columns for each day and compare bird to bird


for(i in 1:length(trans_reslists)){
  res <- colSums(sapply(trans_reslists[[i]]$daily[,2:6], as.numeric))
  res[1] <- res[1]/length(trans_reslists[[i]]$daily$ID)
  res[6] <- round(res[2]/length(trans_reslists[[i]]$daily$bottom),0)
  res[7] <- round(res[3]/length(trans_reslists[[i]]$daily$mid),0)
  res[8] <- round(res[4]/length(trans_reslists[[i]]$daily$top),0)
  res[9] <- round(res[5]/length(trans_reslists[[i]]$daily$total),0)
  daily_colsum <- rbind(daily_colsum,res)
}

colnames(daily_colsum) <- c("ID","bottom","mid","top","total","bottom_A","mid_A","top_a","total_A")
daily_colsum
hold <- daily_colsum[order(daily_colsum$total_A,decreasing = T),]

summary(hold[,6:9])
boxplot(hold[,6:9])

low_act <- c()
med_act <- c()
high_act <- c()

for(i in 1:length(hold[,1])){
  cur_tol <- hold[i,9]
  if(cur_tol<=12){
    low_act <- c(low_act,hold[i,1])
  }
  if((cur_tol>12) & (cur_tol<=30)){
    med_act <- c(med_act,hold[i,1])
  }
  if(cur_tol>30){
    high_act <- c(high_act, hold[i,1])
  }
}


cluster_table <- data.frame(qpcR:::cbind.na(low_act,med_act,high_act))
cluster_table
write.csv(cluster_table, "../output/organized_birds_by_activity_daily_no_rm_3.csv",row.names = F)
```

```{r make a better csv table for all rooms except 3}

# find which room each ID is in:
updated_table <- data.frame()

all_selected_ids <- c(low_act,med_act,high_act)
new_row <- ""
activity <- ""
room <- ""

for(id in all_selected_ids){
  #find out which activity level id is in 
  if(id %in% low_act){
      activity <- "low"
  } else if( id %in% med_act){
      activity <- "medium"
  } else { 
      activity <- "high"
  }
  #find out which room id is in 
  if(id %in% bird_ids_room_2){
      room <- "2"
  } else if(id %in% bird_ids_room_3 ){
      room <- "3"
  } else if( id %in% bird_ids_room_8 ){
      room <- "8"
  } else if( id %in% bird_ids_room_11 ) { 
      room <- "11"
  }
  #add row to updated table
  new_row <- c(room, id, activity)
  updated_table <- rbind(updated_table, new_row)
}

colnames(updated_table) <- c("Room", "Bird ID", "Activity Level")
write.csv(updated_table, "../output/organized_birds_by_activity_daily_no_rm_3_nice_table.csv",row.names = F)
```

## Jumpy table for the separated samples

```{r make a jumpy table for the low activity birds no room 3}
# Aggregate the low activity birds
low_act_bird_ids <- na.trim(cluster_table$low_act)

#make a table of the samples
low_act_bird_frame <- data.frame()

for(id in low_act_bird_ids){
  curr_bird <- daily[grep(id,daily$sample),]
  low_act_bird_frame <- rbind(low_act_bird_frame,curr_bird)
}

low_act_bird_frame[,3:6] <- sapply(low_act_bird_frame[,3:6], as.numeric)
low_act_bird_frame["day"] <- as.character(str_split_fixed(low_act_bird_frame$sample, ".",6)[,6])
low_act_agg_tab <- aggregate(low_act_bird_frame[,3:6],by = list(low_act_bird_frame$day), FUN = mean)
colnames(low_act_agg_tab) <- c("day","bottom","mid","top","total")

# Aggregate the medium activity birds
med_act_bird_ids <- na.trim(cluster_table$med_act)

#make a table of the samples
med_act_bird_frame <- data.frame()

for(id in med_act_bird_ids){
  curr_bird <- daily[grep(id,daily$sample),]
  med_act_bird_frame <- rbind(med_act_bird_frame,curr_bird)
}

med_act_bird_frame[,3:6] <- sapply(med_act_bird_frame[,3:6], as.numeric)
med_act_bird_frame["day"] <- as.character(str_split_fixed(med_act_bird_frame$sample, ".",6)[,6])
med_act_agg_tab <- aggregate(med_act_bird_frame[,3:6],by = list(med_act_bird_frame$day), FUN = mean)
colnames(med_act_agg_tab) <- c("day","bottom","mid","top","total")

# Aggregate the high activity birds
high_act_bird_ids <- na.trim(cluster_table$high_act)

#make a table of the samples
high_act_bird_frame <- data.frame()

for(id in high_act_bird_ids){
  curr_bird <- daily[grep(id,daily$sample),]
  high_act_bird_frame <- rbind(high_act_bird_frame,curr_bird)
}

high_act_bird_frame[,3:6] <- sapply(high_act_bird_frame[,3:6], as.numeric)
high_act_bird_frame["day"] <- as.character(str_split_fixed(high_act_bird_frame$sample, ".",6)[,6])
high_act_agg_tab <- aggregate(high_act_bird_frame[,3:6],by = list(high_act_bird_frame$day), FUN = mean)
colnames(high_act_agg_tab) <- c("day","bottom","mid","top","total")

# plot the low activity birds
low_act_grp <- data.frame(x = as.Date(low_act_agg_tab$day), y = c(low_act_agg_tab$bottom, low_act_agg_tab$mid, low_act_agg_tab$top), group= c(rep("Bottom",nrow(low_act_agg_tab)),rep("Mid",nrow(low_act_agg_tab)),rep("Top",nrow(low_act_agg_tab))), activity=c(rep('Low',nrow(low_act_agg_tab)*3)))

med_act_grp <- data.frame(x = as.Date(med_act_agg_tab$day), y = c(med_act_agg_tab$bottom, med_act_agg_tab$mid, med_act_agg_tab$top), group= c(rep("Bottom",nrow(med_act_agg_tab)),rep("Mid",nrow(med_act_agg_tab)),rep("Top",nrow(med_act_agg_tab))), activity=c(rep('Medium',nrow(low_act_agg_tab)*3)))

# plot the low activity birds
high_act_grp <- data.frame(x = as.Date(high_act_agg_tab$day), y = c(high_act_agg_tab$bottom, high_act_agg_tab$mid, high_act_agg_tab$top), group= c(rep("Bottom",nrow(high_act_agg_tab)),rep("Mid",nrow(high_act_agg_tab)),rep("Top",nrow(high_act_agg_tab))), activity=c(rep('High',nrow(low_act_agg_tab)*3)))

combo_table <- rbind(low_act_grp, med_act_grp, high_act_grp)

q <-ggplot(combo_table, aes(x,y,col=activity))+
  geom_line(aes(col=activity)) +
  facet_grid(factor(group,levels=c("Top","Mid","Bottom"))~ ., scales='free_y') +
  labs(title=paste0("Activity Birds Transitions no Room 3 (n=",length(unique(daily$ID)),")"), color="Activity Level")+
  scale_x_date(name="Weeks",breaks = seq(min(combo_table$x),max(combo_table$x),by="week"),labels = as.numeric(format(seq(min(combo_table$x),max(combo_table$x),by="week"),"%U"))+23)+
  scale_y_continuous(name="Average Transitions Into",n.breaks = 8) +
  scale_color_manual(values=c("Low"="royalblue","Medium"="tomato","High" = "seagreen")) +
  theme_bw()
  ggsave(q, filename="../figures/active_transitions_no_rm3_set_2.png",device="png")

```

# Zone Occupying Table No Room 3

```{r make a zone occupation table without Room 3}
library(dplyr)

no_room_3_zone_table <- data.frame()
result <- ""

for(item in trans_reslist_room_2){
  result <- calc_zone_duration("room 2", item$ID, item$raw)
  no_room_3_zone_table <- rbind(no_room_3_zone_table, result)
}
for(item in trans_reslist_room_8){
  result <- calc_zone_duration("room 8", item$ID, item$raw)
  no_room_3_zone_table <- rbind(no_room_3_zone_table, result)
}
for(item in trans_reslist_room_11){
  result <- calc_zone_duration("room 11", item$ID, item$raw)
  no_room_3_zone_table <- rbind(no_room_3_zone_table, result)
}

# change the resultant times to numerics as opposed to chars
no_room_3_zone_table[,3:5] <- sapply(no_room_3_zone_table[,3:5],function(x) as.numeric(as.character(x)))
no_room_3_zone_table[,3:5] <- (no_room_3_zone_table[,3:5])/60
# calculate the number of days observed
no_room_3_zone_table["days_observed"]<- round((rowSums(no_room_3_zone_table[,3:5])/60)/24)
colnames(no_room_3_zone_table) <-  c("Room","ID", "Time in Bottom","Time in Middle", "Time in Top","Days Observed")


write.csv(no_room_3_zone_table, "../output/zone_time_per_id_no_3.csv", row.names=F)

ave_time_per_room_no_3 <- aggregate(cbind(no_room_3_zone_table$"Time in Bottom",no_room_3_zone_table$"Time in Middle",no_room_3_zone_table$"Time in Top"),list(no_room_3_zone_table$Room),mean)

colnames(ave_time_per_room_no_3) <- c("Room", "Average Time in Bottom", "Average Time in Middle", "Average Time in Top")

write.csv(ave_time_per_room_no_3, "../output/zone_time_per_room_no_3.csv", row.names=F)
```